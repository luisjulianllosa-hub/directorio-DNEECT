<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Directorio Telef√≥nico - Prueba CSV ‚Üí Map</title>
<style>
  body{margin:0;font-family:Arial,Helvetica,sans-serif;height:100vh;display:flex}
  #sidebar{width:320px;padding:12px;box-sizing:border-box;border-right:1px solid #ddd;overflow:auto}
  #map{flex:1;min-height:100vh}
  .contact{padding:8px;border-bottom:1px solid #eee}
</style>
</head>
<body>

<div id="sidebar">
  <h3>Directorio (debug)</h3>
  <div id="info">Cargando...</div>
  <div id="list"></div>
</div>

<div id="map"></div>

<script>
/* ====== CONFIG ====== */
const MAPS_API_KEY = 'AIzaSyDCKEw0krkL1pGWCxPji_SYqyznd7-lQ_k'; // ‚Üê reemplaza aqu√≠
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTHzFhXhtdNJsV9WV-Kmf_bqaFnI2vTaulIyLlA2BsDi5aY-ATzs47PU6FAtcoMJQaIaOSh35wC-M9/pub?gid=0&single=true&output=csv";

/* ====== RUTINAS AUX ====== */
function loadScript(src){
  return new Promise((resolve,reject)=>{
    if(document.querySelector('script[src="'+src+'"]')) return resolve();
    const s = document.createElement('script');
    s.src = src; s.async = true; s.defer = true;
    s.onload = ()=>resolve();
    s.onerror = ()=>reject(new Error('Error cargando script: '+src));
    document.head.appendChild(s);
  });
}

/* Parser CSV simple pero que maneja comillas dobles y comas dentro de campos */
function parseCSV(text, delimiter=','){
  const rows = [];
  let cur = '', row = [], inQuotes = false;
  for (let i=0;i<text.length;i++){
    const ch = text[i];
    const nxt = text[i+1];
    if (ch === '"'){
      if (inQuotes && nxt === '"'){ cur += '"'; i++; } // doble comilla -> comilla literal
      else { inQuotes = !inQuotes; }
    } else if (ch === delimiter && !inQuotes){
      row.push(cur); cur = '';
    } else if ((ch === '\n' || ch === '\r') && !inQuotes){
      if (ch === '\r' && text[i+1] === '\n'){ i++; } // CRLF
      row.push(cur); cur = '';
      // evitar filas vac√≠as al final
      if (row.length === 1 && row[0] === '') { row = []; continue; }
      rows.push(row); row = [];
    } else {
      cur += ch;
    }
  }
  // push √∫ltimo
  if (cur !== '' || row.length){
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

/* Normaliza cabeceras para compararlas m√°s f√°cilmente */
function normalizeHeader(h){
  return (h||'').toString().trim().toLowerCase()
           .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
           .replace(/\s+/g,'');
}

/* ====== APP ====== */
let map, markers = [], markerCluster, contacts = [];

async function initApp(){
  const MARKERCLUSTER_SRC = 'https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js';
  const MAPS_SRC = `https://maps.googleapis.com/maps/api/js?key=${MAPS_API_KEY}`;

  const infoEl = document.getElementById('info');

  try {
    infoEl.textContent = 'Cargando librer√≠as...';
    // cargo primero markerclusterer y maps (espera ambos)
    await Promise.all([ loadScript(MARKERCLUSTER_SRC), loadScript(MAPS_SRC) ]);
    console.log('MarkerClusterer cargado?', !!window.markerClusterer);
    console.log('Google Maps cargado?', !!window.google && !!window.google.maps);

    infoEl.textContent = 'Descargando CSV...';
    const resp = await fetch(SHEET_URL);
    if (!resp.ok) throw new Error('HTTP ' + resp.status + ' al descargar CSV. Comprueba que la hoja est√° "Publish to web" p√∫blica.');
    const txt = await resp.text();

    // DEBUG: imprimir primeros 200 chars
    console.log('CSV preview:', txt.slice(0,500));

    // parse CSV
    const rows = parseCSV(txt, ',');
    if (rows.length < 2) {
      infoEl.textContent = 'CSV vac√≠o o no tiene datos. Revisa la URL y que la hoja est√© publicada como CSV.';
      console.warn('CSV rows:', rows);
      return;
    }

    // headers y normalizaci√≥n
    const rawHeaders = rows.shift().map(h=>h.replace(/^\uFEFF/,'').trim()); // quitar BOM si existe
    const normHeaders = rawHeaders.map(normalizeHeader);
    console.log('Headers:', rawHeaders, '‚Üí', normHeaders);

    // identificar √≠ndices relevantes (flexible)
    const idx = {};
    normHeaders.forEach((h,i)=>{
      if (h.includes('institu')) idx.institucion = i;
      else if (h.includes('cargo')) idx.cargo = i;
      else if (h.includes('nombre') || h.includes('name')) idx.nombre = i;
      else if (h.includes('correo') || h.includes('email')) idx.correo = i;
      else if (h.includes('telefono') || h.includes('tel') || h.includes('phone')) idx.telefono = i;
      else if (h.includes('area') || h.includes('depart')) idx.area = i;
      else if (h.includes('sede') || h.includes('office')) idx.sede = i;
      else if (h.includes('ubicacion') || h.includes('direccion') || h.includes('address')) idx.ubicacion = i;
      else if (h === 'lat' || h.includes('latitud') || h.includes('latitude')) idx.lat = i;
      else if (h === 'lng' || h === 'lon' || h.includes('long') || h.includes('longitud') || h.includes('longitude')) idx.lng = i;
    });

    // Mapear filas a objetos
    contacts = rows.map(r=>{
      const get = k => (typeof idx[k] !== 'undefined' && r[idx[k]] !== undefined) ? r[idx[k]].trim() : '';
      const latStr = get('lat').replace(',', '.');
      const lngStr = get('lng').replace(',', '.');
      return {
        institucion: get('institucion'),
        cargo: get('cargo'),
        nombre: get('nombre'),
        correo: get('correo'),
        telefono: get('telefono'),
        area: get('area'),
        sede: get('sede'),
        ubicacion: get('ubicacion'),
        lat: parseFloat(latStr),
        lng: parseFloat(lngStr)
      };
    }).filter(c => !isNaN(c.lat) && !isNaN(c.lng));

    console.log('Contacts parsed:', contacts.length, contacts.slice(0,5));
    infoEl.textContent = `Datos cargados: ${contacts.length} contactos`;

    if (contacts.length === 0){
      infoEl.textContent = 'No se encontraron filas con lat/lng v√°lidos. Revisa tus columnas Lat y Lng.';
      return;
    }

    // inicializar mapa y markers
    initMapAndMarkers();

  } catch (err) {
    console.error(err);
    document.getElementById('info').textContent = 'Error (mira consola): ' + (err.message || err);
  }
}

function initMapAndMarkers(){
  // crear mapa
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 6,
    center: { lat: -12.0464, lng: -77.0428 }
  });

  // limpiar si hab√≠a algo
  markers.forEach(m=>m.setMap(null));
  markers = [];
  if (markerCluster) {
    try { markerCluster.clearMarkers(); } catch(e){ console.warn(e); }
  }

  const bounds = new google.maps.LatLngBounds();

  contacts.forEach(c=>{
    const pos = { lat: c.lat, lng: c.lng };
    const m = new google.maps.Marker({ position: pos, map: map, title: c.nombre || c.institucion });
    const iw = new google.maps.InfoWindow({ content:
      `<div style="font-size:13px"><strong>${c.nombre||''}</strong><br>${c.cargo||''} ${c.institucion?(' - '+c.institucion):''}<br>${c.sede?('üìç '+c.sede):''}<br><a href="mailto:${c.correo}">${c.correo||''}</a> <br>üìû ${c.telefono||''}</div>`
    });
    m.addListener('click', ()=> iw.open(map, m));
    markers.push(m);
    bounds.extend(pos);
  });

  // ajustar vista
  if (contacts.length === 1) {
    map.setCenter(bounds.getCenter());
    map.setZoom(12);
  } else {
    map.fitBounds(bounds);
  }

  // crear cl√∫ster (si la librer√≠a est√° disponible)
  if (window.markerClusterer && markerClusterer && typeof markerClusterer.MarkerClusterer === 'function') {
    markerCluster = new markerClusterer.MarkerClusterer({ map, markers });
    console.log('MarkerClusterer instanciado');
  } else if (window.MarkerClusterer) {
    // fallback antiguo
    markerCluster = new MarkerClusterer(map, markers);
    console.log('MarkerClusterer (fallback) instanciado');
  } else {
    console.warn('No se pudo instanciar MarkerClusterer (no est√° disponible)');
  }

  // llenar lista lateral sencilla (debug)
  const list = document.getElementById('list');
  list.innerHTML = '';
  contacts.forEach(c => {
    const d = document.createElement('div'); d.className='contact';
    d.innerHTML = `<strong>${c.nombre||c.institucion}</strong><br><small>${c.cargo||''}</small><br>Lat: ${c.lat}, Lng: ${c.lng}`;
    list.appendChild(d);
  });
}

/* arrancar */
initApp();
</script>

</body>
</html>



