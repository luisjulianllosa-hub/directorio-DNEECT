<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Directorio Telef√≥nico</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; display:flex; height:100vh; }
  #sidebar { width:30%; background:#f7f7f7; padding:15px; box-sizing:border-box; overflow-y:auto; border-right:1px solid #ccc; transition:transform 0.3s ease; }
  #map { flex:1; }
  h2 { margin-top:0; }
  input, select, button { width:100%; padding:8px; margin-bottom:10px; box-sizing:border-box; }
  .accordion { background:#e9ecef; padding:10px; cursor:pointer; margin-bottom:5px; border:none; text-align:left; outline:none; font-size:16px; border-radius:4px; }
  .panel { display:none; padding:10px; background:#fff; margin-bottom:10px; border-radius:4px; }
  .contact { margin-bottom:10px; padding:8px; border-bottom:1px solid #ddd; cursor:pointer; }
  .contact strong { font-size:14px; }
  .buttons button { margin-right:5px; padding:5px 10px; border:none; border-radius:4px; cursor:pointer; font-size:12px; }
  .btn-call { background:#28a745; color:#fff; }
  .btn-email { background:#007bff; color:#fff; }
  .btn-route { background:#ff9800; color:#fff; }
  #btnExport { background:#6c757d; color:#fff; }
  #menu-btn { display:none; }
  @media(max-width:1024px){
    #menu-btn { display:block; position:fixed; top:15px; left:15px; background:#007bff; color:#fff; border:none; padding:10px 15px; font-size:18px; border-radius:4px; z-index:10000; cursor:pointer; width:auto; }
    #sidebar { position:fixed; top:0; left:0; width:80%; max-width:300px; height:100%; background:#f7f7f7; box-shadow:2px 0 5px rgba(0,0,0,0.3); transform:translateX(-100%); z-index:9999; }
    #sidebar.show { transform:translateX(0); }
    #map { flex:none; width:100%; height:100vh; }
  }
  #locate-btn { position: fixed; bottom:20px; right:20px; width:50px; height:50px; background:#007bff; color:#fff; border:none; border-radius:50%; font-size:22px; cursor:pointer; z-index:1000; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 6px rgba(0,0,0,0.2); }
  #locate-btn:hover{ background:#0056b3; }
</style>
</head>
<body>

<button id="menu-btn">‚ò∞</button>

<div id="sidebar">
  <h2>Directorio Telef√≥nico</h2>
  <input type="text" id="search" placeholder="Buscar por nombre o instituci√≥n">
  <select id="filterInstitucion"><option value="">Filtrar por Instituci√≥n</option></select>
  <select id="filterArea"><option value="">Filtrar por √Årea</option></select>
  <select id="groupBy">
    <option value="">Sin agrupar</option>
    <option value="institucion">Agrupar por Instituci√≥n</option>
    <option value="sede">Agrupar por Sede</option>
  </select>
  <button id="btnExport">Exportar CSV</button>
  <div id="list"></div>
</div>

<div id="map"></div>
<button id="locate-btn" title="Mostrar mi ubicaci√≥n">üìç</button>

<!-- MarkerClusterer (ruta UMD correcta) -->
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.umd.js"></script>

<script>
// ---------------- CONFIG ----------------
const API_KEY = "AIzaSyDCKEw0krkL1pGWCxPji_SYqyznd7-lQ_k"; // reemplaza si lo deseas
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTHzFhXhtdNJsV9WV-Kmf_bqaFnI2vTaulIyLlA2BsDi5aY-ATzs47PU6FAtcoMJQaIaOSh35wC-M9/pub?gid=0&single=true&output=csv";
// ----------------------------------------

let contacts = [], map, markers = [], markerCluster = null, userMarker = null;

// Cargar Google Maps con librer√≠a `marker` (necesaria para AdvancedMarkerElement/PinElement)
function loadGoogleMaps(callback){
  const s = document.createElement("script");
  s.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=marker`;
  s.async = true; s.defer = true;
  s.onload = callback;
  s.onerror = ()=>console.error("No se pudo cargar la librer√≠a de Google Maps. Revisa tu API key / conexi√≥n.");
  document.head.appendChild(s);
}

// Inicializar mapa
function initMap(){
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 6,
    center: { lat: -12.0464, lng: -77.0428 }
  });
  map.addListener("click", ()=>{ if(window.innerWidth <= 1024) document.getElementById("sidebar").classList.remove("show"); });
  loadData();
}

/* ---------------- CSV PARSER ROBUSTO ----------------
   - Detecta delimiter por la cabecera (',' o ';')
   - Soporta campos entrecomillados y comillas escapadas ("")
*/
function parseCSV(text){
  const firstLine = text.split(/\r?\n/)[0] || "";
  const commaCount = (firstLine.match(/,/g)||[]).length;
  const semicolonCount = (firstLine.match(/;/g)||[]).length;
  const delimiter = (semicolonCount > commaCount) ? ";" : ",";

  const lines = text.split(/\r?\n/);
  const rows = [];

  for(const line of lines){
    // parse line character-by-character to handle quotes
    const row = [];
    let cur = "";
    let inQuotes = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"'){
        if(inQuotes && line[i+1] === '"'){ // escaped quote ""
          cur += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if(ch === delimiter && !inQuotes){
        row.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    // push last field (even if empty)
    row.push(cur);

    // skip empty final lines
    if(row.length === 1 && row[0] === "") continue;
    rows.push(row);
  }

  return rows;
}

// Normaliza encabezados del CSV (quita acentos y espacios)
  function normalizeHeader(h) {
    return h
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "")
      .trim();
  }
  
// Carga y parsea el CSV publicado de Google Sheets
//const headers = rows.shift().map(h => String(h).trim().toLowerCase());
async function loadData(){
  try {
    const res = await fetch(SHEET_URL);
    if(!res.ok) throw new Error("Respuesta del CSV no OK: " + res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    const headers = rows.shift().map(h => normalizeHeader(h));

    if(!rows || rows.length <= 1){
      console.warn("CSV vac√≠o o malformado. Filas:", rows ? rows.length : 0);
      return;
    }

    
    contacts = rows.map(cols=>{
      const obj = {};
      headers.forEach((h,i)=> obj[h] = (cols[i]||"").trim());
      return {
        institucion: obj["institucion"] || "",
        cargo: obj["cargo"] || "",
        nombre: obj["nombre"] || "",
        correo: obj["correo"] || "",
        telefono: obj["telefono"] || "",
        area: obj["area"] || "",
        sede: obj["sede"] || "",
        ubicacion: obj["ubicacion"] || "",
        // Aqu√≠ el arreglo para latitud/longitud correcto
        lat: parseFloat(obj["lat"] || obj["latitud"]),
        lng: parseFloat(obj["lng"] || obj["longitud"])
      };
    }).filter(c => !isNaN(c.lat) && !isNaN(c.lng));

    console.log("Contactos cargados:", contacts.length);
    populateFilters();
    renderContacts(contacts);
    updateMarkers(contacts);
  } catch(err){
    console.error("Error cargando datos:", err);
  }
}

/* ---------------- FILTROS ---------------- */
function populateFilters(){
  const instSelect = document.getElementById("filterInstitucion");
  const areaSelect = document.getElementById("filterArea");
  const insts = [...new Set(contacts.map(c=>c.institucion))].filter(Boolean).sort();
  const areas = [...new Set(contacts.map(c=>c.area))].filter(Boolean).sort();
  insts.forEach(i=>{ const o=document.createElement("option"); o.value=i; o.textContent=i; instSelect.appendChild(o); });
  areas.forEach(a=>{ const o=document.createElement("option"); o.value=a; o.textContent=a; areaSelect.appendChild(o); });
}

/* ---------------- MARKERS (AdvancedMarkerElement + PinElement) ---------------- */
function updateMarkers(data){
  // eliminar marcadores previos
  markers.forEach(m => {
    try { m.map = null; } catch(e){ /* ignore */ }
  });
  markers = [];

  if(markerCluster && typeof markerCluster.clearMarkers === "function"){
    try { markerCluster.clearMarkers(); } catch(e){ /* ignore */ }
  }

  const bounds = new google.maps.LatLngBounds();

  data.forEach(c=>{
    try {
      // crear pin visual (PinElement provisto por la librer√≠a 'marker')
      const pin = new google.maps.marker.PinElement({
        background: "#007bff",
        borderColor: "#fff",
        glyphColor: "#fff"
      });

      const marker = new google.maps.marker.AdvancedMarkerElement({
        position: { lat: c.lat, lng: c.lng },
        title: c.nombre,
        map: map,
        content: pin.element
      });

      marker.contactId = c.nombre; // id para b√∫squeda desde la lista

      const info = new google.maps.InfoWindow({ content: contactInfoHTML(c) });
      // abrir info anclado al marker (compatible con AdvancedMarkerElement)
      marker.addListener("click", ()=> info.open({ anchor: marker, map }));

      markers.push(marker);
      if(marker.position) bounds.extend(marker.position);
    } catch(e){
      console.warn("No se pudo crear AdvancedMarkerElement para:", c.nombre, e);
    }
  });

  // crear clusterer (la UMD expone objeto `markerClusterer`)
  try {
    markerCluster = new markerClusterer.MarkerClusterer({ map, markers });
  } catch(e) {
    console.warn("Error creando MarkerClusterer:", e);
  }

  if(!bounds.isEmpty()) map.fitBounds(bounds);
}

/* ---------------- UI / Lista / Agrupador ---------------- */
function contactInfoHTML(c){
  return `<div style="font-size:14px;">
    <strong>${c.nombre}</strong><br>
    ${c.cargo} - ${c.institucion}<br>
    üìç ${c.sede}<br><br>
    <a href="tel:${c.telefono}" style="display:inline-block;padding:6px 12px;background:#28a745;color:#fff;border-radius:4px;text-decoration:none;">üìû Llamar</a>
    <a href="mailto:${c.correo}" style="display:inline-block;padding:6px 12px;background:#007bff;color:#fff;border-radius:4px;text-decoration:none;margin-left:5px;">üìß Email</a>
    <br><br>
    <button onclick="openDirections(${c.lat},${c.lng}, this)" style="background:#ff9800;color:#fff;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;">üó∫ C√≥mo llegar</button>
  </div>`;
}

function renderContacts(data){
  const groupBy = document.getElementById("groupBy").value;
  const container = document.getElementById("list");
  container.innerHTML = "";
  if(!groupBy){
    data.forEach(c => container.innerHTML += contactCardHTML(c));
    return;
  }
  const grouped = {};
  data.forEach(c => {
    const key = c[groupBy] || "Sin especificar";
    if(!grouped[key]) grouped[key] = [];
    grouped[key].push(c);
  });
  Object.keys(grouped).forEach(group => {
    container.innerHTML += `<button class="accordion">${group} (${grouped[group].length})</button><div class="panel">${grouped[group].map(c=>contactCardHTML(c)).join("")}</div>`;
  });
  initAccordions();
}

function contactCardHTML(c){
  // escapar comillas simples en el onclick
  const safeName = c.nombre.replace(/'/g,"\\'");
  return `<div class="contact" onclick="focusMarker('${safeName}')">
    <strong>${c.nombre}</strong><br>
    <small>${c.cargo} - ${c.institucion}</small><br>
    üìç ${c.sede}
    <div class="buttons">
      <button class="btn-call" onclick="event.stopPropagation(); location.href='tel:${c.telefono}'">üìû Llamar</button>
      <button class="btn-email" onclick="event.stopPropagation(); location.href='mailto:${c.correo}'">üìß Email</button>
      <button class="btn-route" onclick="event.stopPropagation(); openDirections(${c.lat},${c.lng}, this)">üó∫ C√≥mo llegar</button>
    </div>
  </div>`;
}

function initAccordions(){
  const acc = document.getElementsByClassName("accordion");
  for(let i=0;i<acc.length;i++){
    acc[i].addEventListener("click", function(){
      this.classList.toggle("active");
      const panel = this.nextElementSibling;
      panel.style.display = (panel.style.display === "block") ? "none" : "block";
    });
  }
}

/* ---------------- B√öSQUEDA / FILTROS ---------------- */
document.getElementById("search").addEventListener("input", filterContacts);
document.getElementById("filterInstitucion").addEventListener("change", filterContacts);
document.getElementById("filterArea").addEventListener("change", filterContacts);
document.getElementById("groupBy").addEventListener("change", ()=> renderContacts(getFilteredContacts()));
document.getElementById("btnExport").addEventListener("click", ()=> exportCSV(getFilteredContacts()));

function getFilteredContacts(){
  const q = (document.getElementById("search").value || "").toLowerCase();
  const instFilter = document.getElementById("filterInstitucion").value;
  const areaFilter = document.getElementById("filterArea").value;
  return contacts.filter(c =>
    (c.nombre.toLowerCase().includes(q) || c.institucion.toLowerCase().includes(q)) &&
    (instFilter === "" || c.institucion === instFilter) &&
    (areaFilter === "" || c.area === areaFilter)
  );
}

function filterContacts(){
  const filtered = getFilteredContacts();
  renderContacts(filtered);
  updateMarkers(filtered);
}

/* ---------------- EXPORT ---------------- */
function exportCSV(data){
  let csv = "Instituci√≥n,Cargo,Nombre,Correo,Tel√©fono,√Årea,Sede,Ubicaci√≥n,Latitud,Longitud\n";
  data.forEach(c=>{
    // escapa comillas dobles si hay
    const q = (s) => `"${String(s||"").replace(/"/g, '""')}"`;
    csv += `${q(c.institucion)},${q(c.cargo)},${q(c.nombre)},${q(c.correo)},${q(c.telefono)},${q(c.area)},${q(c.sede)},${q(c.ubicacion)},${c.lat},${c.lng}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "directorio_filtrado.csv"; a.click();
}

/* ---------------- UI helpers ---------------- */
document.getElementById("menu-btn").addEventListener("click", ()=> document.getElementById("sidebar").classList.toggle("show"));

document.getElementById("locate-btn").addEventListener("click", ()=>{
  if(!navigator.geolocation){ alert("Tu navegador no soporta geolocalizaci√≥n."); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    // quitar userMarker anterior si existe
    try{ if(userMarker) userMarker.map = null; } catch(e){}
    // pin azul para usuario
    const pin = new google.maps.marker.PinElement({ background: "#0000ff", borderColor: "#fff", glyphColor: "#fff" });
    userMarker = new google.maps.marker.AdvancedMarkerElement({
      position: userPos,
      map,
      title: "Tu ubicaci√≥n",
      content: pin.element
    });
    map.setCenter(userPos);
    map.setZoom(12);
  }, ()=> alert("No se pudo obtener tu ubicaci√≥n."));
});

// abrir direcciones
function openDirections(destLat, destLng, btn=null){
  if(btn){ btn.disabled = true; btn.textContent = "Calculando..."; }
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const originLat = pos.coords.latitude, originLng = pos.coords.longitude;
      window.open(`https://www.google.com/maps/dir/?api=1&origin=${originLat},${originLng}&destination=${destLat},${destLng}`,"_blank");
      if(btn){ btn.disabled=false; btn.textContent="üó∫ C√≥mo llegar"; }
    }, ()=>{
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}`,"_blank");
      if(btn){ btn.disabled=false; btn.textContent="üó∫ C√≥mo llegar"; }
    }, { timeout:7000 });
  } else {
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}`,"_blank");
    if(btn){ btn.disabled=false; btn.textContent="üó∫ C√≥mo llegar"; }
  }
}

// centrar y abrir InfoWindow desde la lista (rebote visual)
function focusMarker(contactName){
  const marker = markers.find(m => m.contactId === contactName);
  if(!marker) return;
  // centrar + zoom
  if(marker.position) map.setCenter(marker.position);
  map.setZoom(14);

  // abrir InfoWindow
  const c = contacts.find(x => x.nombre === contactName);
  if(c){
    const info = new google.maps.InfoWindow({ content: contactInfoHTML(c) });
    info.open({ anchor: marker, map });
  }

  // efecto visual en el elemento del marker (si existe)
  try{
    const el = marker.element || marker.content || (marker.getElement && marker.getElement());
    if(el && el.style){
      el.style.transition = "transform 0.25s";
      el.style.transform = "translateY(-8px) scale(1.05)";
      setTimeout(()=> { el.style.transform = ""; }, 600);
    }
  }catch(e){ /* no cr√≠tico */ }
}

/* ---------------- Arranque ---------------- */
loadGoogleMaps(initMap);
</script>

</body>
</html>
















