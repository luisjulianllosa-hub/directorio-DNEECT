<!DOCTYPE html> 
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Directorio Telef√≥nico</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  body { margin:0; font-family:Arial,sans-serif; display:flex; height:100vh; }
  #sidebar { width:30%; background:#f7f7f7; padding:15px; box-sizing:border-box; overflow-y:auto; border-right:1px solid #ccc; transition:transform 0.3s ease; }
  #map { flex:1; }
  h2 { margin-top:0; }
  input, select, button { width:100%; padding:8px; margin-bottom:10px; box-sizing:border-box; }
  .contact { margin-bottom:10px; padding:8px; border-bottom:1px solid #ddd; cursor:pointer; }
  .contact strong { font-size:14px; }
  .buttons button { margin:5px 3px 0 0; padding:5px 10px; border:none; border-radius:4px; cursor:pointer; font-size:12px; }
  .btn-call { background:#28a745; color:#fff; }
  .btn-email { background:#007bff; color:#fff; }
  .btn-route { background:#ff9800; color:#fff; }
  #btnExport { background:#6c757d; color:#fff; }
  #menu-btn { display:none; }
  details { margin-bottom:8px; border:1px solid #ccc; border-radius:4px; background:#fff; }
  summary { padding:6px; cursor:pointer; font-weight:bold; background:#eee; }
  @media(max-width:1024px){
    #menu-btn { display:block; position:fixed; top:15px; left:15px; background:#007bff; color:#fff; border:none; padding:10px 15px; font-size:18px; border-radius:4px; z-index:10000; cursor:pointer; width:auto; }
    #sidebar { position:fixed; top:0; left:0; width:80%; max-width:300px; height:100%; background:#f7f7f7; box-shadow:2px 0 5px rgba(0,0,0,0.3); transform:translateX(-100%); z-index:9999; }
    #sidebar.show { transform:translateX(0); }
    #map { flex:none; width:100%; height:100vh; }
  }
  #locate-btn { position: fixed; bottom:20px; right:20px; width:50px; height:50px; background:#007bff; color:#fff; border:none; border-radius:50%; font-size:22px; cursor:pointer; z-index:1000; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 6px rgba(0,0,0,0.2); }
  #locate-btn:hover{ background:#0056b3; }
</style>
</head>
<body>

<button id="menu-btn">‚ò∞</button>

<div id="sidebar">
  <h2>Directorio Telef√≥nico</h2>
  <input type="text" id="search" placeholder="Buscar por nombre o instituci√≥n">
  <select id="filterInstitucion"><option value="">Filtrar por Instituci√≥n</option></select>
  <select id="filterArea"><option value="">Filtrar por √Årea</option></select>
  <select id="groupBy">
    <option value="">Sin agrupar</option>
    <option value="institucion">Agrupar por Instituci√≥n</option>
    <option value="sede">Agrupar por Sede</option>
  </select>
  <button id="btnExport">Exportar CSV</button>
  <div id="list"></div>
</div>

<div id="map"></div>
<button id="locate-btn" title="Mostrar mi ubicaci√≥n">üìç</button>

<!-- Librer√≠as -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
// ---------------- CONFIG ----------------
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTHzFhXhtdNJsV9WV-Kmf_bqaFnI2vTaulIyLlA2BsDi5aY-ATzs47PU6FAtcoMJQaIaOSh35wC-M9/pub?gid=0&single=true&output=csv";
// ----------------------------------------

let contacts = [], map, markers = L.markerClusterGroup(), userMarker = null;

// Inicializar mapa
map = L.map('map').setView([-12.0464, -77.0428], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
map.addLayer(markers);

/* ---------------- CSV ---------------- */
function parseCSV(text){
  const delimiter = text.includes(";") ? ";" : ",";
  return text.split(/\r?\n/).map(l => l.split(delimiter));
}
function normalizeHeader(h) {
  return h.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g,"").trim();
}

// Cargar datos
async function loadData(){
  const res = await fetch(SHEET_URL);
  const text = await res.text();
  const rows = parseCSV(text);
  const headers = rows.shift().map(h => normalizeHeader(h));
  contacts = rows.map(cols=>{
    const obj = {};
    headers.forEach((h,i)=> obj[h] = (cols[i]||"").trim());
    return {
      institucion: obj["institucion"] || "",
      cargo: obj["cargo"] || "",
      nombre: obj["nombre"] || "",
      correo: obj["correo"] || "",
      telefono: obj["telefono"] || "",
      area: obj["area"] || "",
      sede: obj["sede"] || "",
      lat: parseFloat(obj["lat"] || obj["latitud"]),
      lng: parseFloat(obj["lng"] || obj["longitud"])
    };
  }).filter(c=>!isNaN(c.lat)&&!isNaN(c.lng));
  populateFilters();
  applyFilters();
}

/* ---------------- FILTROS ---------------- */
function populateFilters(){
  const instSelect = document.getElementById("filterInstitucion");
  const areaSelect = document.getElementById("filterArea");
  [...new Set(contacts.map(c=>c.institucion))].filter(Boolean).sort()
    .forEach(i=>{ const o=document.createElement("option"); o.value=i; o.textContent=i; instSelect.appendChild(o); });
  [...new Set(contacts.map(c=>c.area))].filter(Boolean).sort()
    .forEach(a=>{ const o=document.createElement("option"); o.value=a; o.textContent=a; areaSelect.appendChild(o); });
}

function applyFilters(){
  const search = document.getElementById("search").value.toLowerCase();
  const inst = document.getElementById("filterInstitucion").value;
  const area = document.getElementById("filterArea").value;
  const groupBy = document.getElementById("groupBy").value;

  let filtered = contacts.filter(c=>
    (!search || c.nombre.toLowerCase().includes(search) || c.institucion.toLowerCase().includes(search)) &&
    (!inst || c.institucion === inst) &&
    (!area || c.area === area)
  );

  if(groupBy){
    const grouped = {};
    filtered.forEach(c=>{
      const key = c[groupBy] || "Otros";
      if(!grouped[key]) grouped[key]=[];
      grouped[key].push(c);
    });
    renderGroupedContacts(grouped);
  }else{
    renderContacts(filtered);
  }
  updateMarkers(filtered);
}

/* ---------------- MARKERS ---------------- */
function updateMarkers(data){
  markers.clearLayers();
  const bounds = [];

  data.forEach(c=>{
    const popup = `
      <div>
        <strong>${c.nombre}</strong><br>
        ${c.cargo} - ${c.institucion}<br>
        üìç ${c.sede}<br>
        <div class="buttons">
          <a href="tel:${c.telefono}"><button class="btn-call"><i class="fa fa-phone"></i> Llamar</button></a>
          <a href="mailto:${c.correo}"><button class="btn-email"><i class="fa fa-envelope"></i> Email</button></a>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}" target="_blank"><button class="btn-route"><i class="fa fa-map"></i> Ruta</button></a>
        </div>
      </div>`;
    const marker = L.marker([c.lat,c.lng]).bindPopup(popup);
    marker.contactId = c.nombre;
    markers.addLayer(marker);
    bounds.push([c.lat,c.lng]);
  });

  if(bounds.length) map.fitBounds(bounds);
}

/* ---------------- CONTACT LIST ---------------- */
function contactCardHTML(c){
  return `<div class="contact" onclick="focusMarker('${c.nombre}')">
    <strong>${c.nombre}</strong><br><small>${c.cargo} - ${c.institucion}</small><br>üìç ${c.sede}
    <div class="buttons">
      <a href="tel:${c.telefono}"><button class="btn-call"><i class="fa fa-phone"></i></button></a>
      <a href="mailto:${c.correo}"><button class="btn-email"><i class="fa fa-envelope"></i></button></a>
      <a href="https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}" target="_blank"><button class="btn-route"><i class="fa fa-map"></i></button></a>
    </div>
  </div>`;
}
function renderContacts(data){
  document.getElementById("list").innerHTML = data.map(c=>contactCardHTML(c)).join("");
}
function renderGroupedContacts(grouped){
  let html = "";
  for(const g in grouped){
    html += `<details><summary>${g}</summary>` + grouped[g].map(c=>contactCardHTML(c)).join("") + `</details>`;
  }
  document.getElementById("list").innerHTML = html;
}
function focusMarker(name){
  markers.eachLayer(m=>{
    if(m.contactId===name){
      map.setView(m.getLatLng(),14);
      m.openPopup();
    }
  });
}

/* ---------------- UBICACI√ìN ---------------- */
document.getElementById("locate-btn").addEventListener("click",()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude} = pos.coords;
      if(userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([latitude,longitude],{title:"Tu ubicaci√≥n"}).addTo(map);
      map.setView([latitude,longitude],14);
    });
  }
});

/* ---------------- LISTENERS ---------------- */
["search","filterInstitucion","filterArea","groupBy"].forEach(id=>{
  document.getElementById(id).addEventListener("input",applyFilters);
});
document.getElementById("menu-btn").addEventListener("click",()=>{
  document.getElementById("sidebar").classList.toggle("show");
});
document.getElementById("btnExport").addEventListener("click",()=>{
  let csv = "Nombre,Instituci√≥n,Cargo,Correo,Tel√©fono,√Årea,Sede,Lat,Lng\n";
  contacts.forEach(c=>{
    csv += `"${c.nombre}","${c.institucion}","${c.cargo}","${c.correo}","${c.telefono}","${c.area}","${c.sede}",${c.lat},${c.lng}\n`;
  });
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="directorio.csv"; a.click();
  URL.revokeObjectURL(url);
});

/* ---------------- START ---------------- */
loadData();
</script>
</body>
</html>






