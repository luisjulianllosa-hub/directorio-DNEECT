<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Directorio Telef√≥nico</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; display:flex; height:100vh; }
  #sidebar { width:30%; background:#f7f7f7; padding:15px; box-sizing:border-box; overflow-y:auto; border-right:1px solid #ccc; transition:transform 0.3s ease; }
  #map { flex:1; }
  h2 { margin-top:0; }
  input, select, button { width:100%; padding:8px; margin-bottom:10px; box-sizing:border-box; }
  .accordion { background:#e9ecef; padding:10px; cursor:pointer; margin-bottom:5px; border:none; text-align:left; outline:none; font-size:16px; border-radius:4px; }
  .panel { display:none; padding:10px; background:#fff; margin-bottom:10px; border-radius:4px; }
  .contact { margin-bottom:10px; padding:8px; border-bottom:1px solid #ddd; cursor:pointer; }
  .contact strong { font-size:14px; }
  .buttons button { margin-right:5px; padding:5px 10px; border:none; border-radius:4px; cursor:pointer; font-size:12px; }
  .btn-call { background:#28a745; color:#fff; }
  .btn-email { background:#007bff; color:#fff; }
  .btn-route { background:#ff9800; color:#fff; }
  #btnExport { background:#6c757d; color:#fff; }
  #menu-btn { display:none; }
  @media(max-width:1024px){
    #menu-btn { display:block; position:fixed; top:15px; left:15px; background:#007bff; color:#fff; border:none; padding:10px 15px; font-size:18px; border-radius:4px; z-index:10000; cursor:pointer; width:auto; }
    #sidebar { position:fixed; top:0; left:0; width:80%; max-width:300px; height:100%; background:#f7f7f7; box-shadow:2px 0 5px rgba(0,0,0,0.3); transform:translateX(-100%); z-index:9999; }
    #sidebar.show { transform:translateX(0); }
    #map { flex:none; width:100%; height:100vh; }
  }
  #locate-btn { position: fixed; bottom:20px; right:20px; width:50px; height:50px; background:#007bff; color:#fff; border:none; border-radius:50%; font-size:22px; cursor:pointer; z-index:1000; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 6px rgba(0,0,0,0.2); }
  #locate-btn:hover{ background:#0056b3; }
</style>
</head>
<body>

<button id="menu-btn">‚ò∞</button>

<div id="sidebar">
  <h2>Directorio Telef√≥nico</h2>
  <input type="text" id="search" placeholder="Buscar por nombre o instituci√≥n">
  <select id="filterInstitucion"><option value="">Filtrar por Instituci√≥n</option></select>
  <select id="filterArea"><option value="">Filtrar por √Årea</option></select>
  <select id="groupBy">
    <option value="">Sin agrupar</option>
    <option value="institucion">Agrupar por Instituci√≥n</option>
    <option value="sede">Agrupar por Sede</option>
  </select>
  <button id="btnExport">Exportar CSV</button>
  <div id="list"></div>
</div>

<div id="map"></div>
<button id="locate-btn" title="Mostrar mi ubicaci√≥n">üìç</button>

<!-- MarkerClusterer (UMD) -->
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.umd.js"></script>

<script>
// ---------------- CONFIG ----------------
const API_KEY = "AIzaSyDCKEw0krkL1pGWCxPji_SYqyznd7-lQ_k";   // üëà pon aqu√≠ tu API Key
const MAP_ID = "769e3204db9a9e3ad1a55055";     // üëà pon aqu√≠ tu Map ID (Javascript Vector)
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTHzFhXhtdNJsV9WV-Kmf_bqaFnI2vTaulIyLlA2BsDi5aY-ATzs47PU6FAtcoMJQaIaOSh35wC-M9/pub?gid=0&single=true&output=csv";
// ----------------------------------------

let contacts = [], map, markers = [], markerCluster = null, userMarker = null;

// Cargar Google Maps con librer√≠a `marker`
function loadGoogleMaps(callback){
  const s = document.createElement("script");
  s.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=marker&map_ids=${MAP_ID}`;
  s.async = true; s.defer = true;
  s.onload = callback;
  s.onerror = ()=>console.error("No se pudo cargar Google Maps. Revisa tu API key / conexi√≥n.");
  document.head.appendChild(s);
}

// Inicializar mapa
function initMap(){
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 6,
    center: { lat: -12.0464, lng: -77.0428 },
    mapId: MAP_ID
  });
  loadData();
}

/* ---------------- CSV ---------------- */
function parseCSV(text){
  const delimiter = text.includes(";") ? ";" : ",";
  return text.split(/\r?\n/).map(l => l.split(delimiter));
}
function normalizeHeader(h) {
  return h.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g,"").trim();
}

// Cargar datos de Google Sheets
async function loadData(){
  const res = await fetch(SHEET_URL);
  const text = await res.text();
  const rows = parseCSV(text);
  const headers = rows.shift().map(h => normalizeHeader(h));
  contacts = rows.map(cols=>{
    const obj = {};
    headers.forEach((h,i)=> obj[h] = (cols[i]||"").trim());
    return {
      institucion: obj["institucion"] || "",
      cargo: obj["cargo"] || "",
      nombre: obj["nombre"] || "",
      correo: obj["correo"] || "",
      telefono: obj["telefono"] || "",
      area: obj["area"] || "",
      sede: obj["sede"] || "",
      lat: parseFloat(obj["lat"] || obj["latitud"]),
      lng: parseFloat(obj["lng"] || obj["longitud"])
    };
  }).filter(c=>!isNaN(c.lat)&&!isNaN(c.lng));
  populateFilters();
  renderContacts(contacts);
  updateMarkers(contacts);
}

/* ---------------- FILTROS ---------------- */
function populateFilters(){
  const instSelect = document.getElementById("filterInstitucion");
  const areaSelect = document.getElementById("filterArea");
  [...new Set(contacts.map(c=>c.institucion))].filter(Boolean).sort()
    .forEach(i=>{ const o=document.createElement("option"); o.value=i; o.textContent=i; instSelect.appendChild(o); });
  [...new Set(contacts.map(c=>c.area))].filter(Boolean).sort()
    .forEach(a=>{ const o=document.createElement("option"); o.value=a; o.textContent=a; areaSelect.appendChild(o); });
}

/* ---------------- MARKERS ---------------- */
function updateMarkers(data){
  markers.forEach(m => { try{ m.map = null; }catch(e){} });
  markers=[];
  if(markerCluster){ try{ markerCluster.clearMarkers(); }catch(e){} }

  const bounds = new google.maps.LatLngBounds();

  data.forEach(c=>{
    const pin = new google.maps.marker.PinElement({
      background:"#007bff", borderColor:"#fff", glyphColor:"#fff"
    });
    const marker = new google.maps.marker.AdvancedMarkerElement({
      position:{lat:c.lat,lng:c.lng}, map, title:c.nombre, content: pin.element
    });
    marker.contactId = c.nombre;
    marker.addListener("click",()=>{
      const info = new google.maps.InfoWindow({ content: contactInfoHTML(c) });
      info.open({ anchor: marker, map });
    });
    markers.push(marker);
    bounds.extend(marker.position);
  });

  markerCluster = new markerClusterer.MarkerClusterer({ map, markers });
  if(!bounds.isEmpty()) map.fitBounds(bounds);
}

/* ---------------- CONTACT LIST ---------------- */
function contactInfoHTML(c){
  return `<div><strong>${c.nombre}</strong><br>${c.cargo} - ${c.institucion}<br>üìç ${c.sede}</div>`;
}
function contactCardHTML(c){
  const safeName = c.nombre.replace(/'/g,"\\'");
  return `<div class="contact" onclick="focusMarker('${safeName}')">
    <strong>${c.nombre}</strong><br><small>${c.cargo} - ${c.institucion}</small><br>üìç ${c.sede}
  </div>`;
}
function renderContacts(data){
  document.getElementById("list").innerHTML = data.map(c=>contactCardHTML(c)).join("");
}
function focusMarker(name){
  const marker = markers.find(m=>m.contactId===name);
  if(!marker) return;
  map.setCenter(marker.position);
  map.setZoom(14);
  const c = contacts.find(x=>x.nombre===name);
  if(c){
    const info = new google.maps.InfoWindow({ content: contactInfoHTML(c) });
    info.open({ anchor: marker, map });
  }
}

/* ---------------- ARRANQUE ---------------- */
loadGoogleMaps(initMap);
</script>
</body>
</html>

















